# 小匠串口通讯协议开发示例

## 示例产品

以电饭煲为例，定义协议如下：

### 属性（Attribute）

| attrid | 功能描述     | 属性名称      | 类型  | 读取 | 单位 | 取值范围 | 取值说明                                               |
| ------ | ------------ | ------------- | ----- | ---- | ---- | -------- | ------------------------------------------------------ |
| 1      | 工作状态     | PowerSwitch   | bool  | RW   |      | [0,1]    | 0-待机 1-工作中                                        |
| 2      | 工作模式     | WorkMode      | enum  | RW   |      | [0,4]    | 0（未选择）1（精华煮）2（超快煮）3（煲仔饭）4（粥/汤） |
| 3      | 工作时间     | WorkTime      | uint8 | RW   | 分钟 | [0,120]  | 最大工作时间2小时                                      |
| 4      | 工作剩余时间 | TimeRemaining | uint8 | R    | 分钟 | [0,120]  |                                                        |

### 服务（Service）

| serviceid | 功能     | 输入参数           | 输出参数 | 说明                  |
| --------- | -------- | ------------------ | -------- | --------------------- |
| 1         | 开始工作 | WorkMode，WorkTime | 无       | 发送工作模式+工作时间 |

### 事件（Event）

| eventid | 功能     | 输入参数           | 说明                              |
| ------- | -------- | ------------------ | --------------------------------- |
| 1       | 煮饭完成 | WorkMode，WorkTime | 熟饭完成，上报完成的模式+工作时间 |


## 网络

### 配网指令

**Wi-Fi设备必须**，MCU给模组发送配网指令，模组进入配网状态。

| Head | Length | Ver  | Cmd  | Method | Id          | Data | Chksum |
| ---- | ------ | ---- | ---- | ------ | ----------- | ---- | ------ |
| AA   | 00 09  | 02   | 0A   | E0     | 00 00 00 01 | 01   | A1     |

>  上行：AA 00 09 02 0A E0 00 00 00 01 01 A1
>
>  Ack： AA 00 09 02 0A FF 00 00 00 01 00 BF

### 查询网络状态

MCU向模组查询网络状态，**建议上电后查询一次，以后每1分钟查询一次即可。**

| Head | Length | Ver  | Cmd  | Method | Id          | Data | Chksum |
| ---- | ------ | ---- | ---- | ------ | ----------- | ---- | ------ |
| AA   | 00 09  | 02   | 0A   | E5     | 00 00 00 01 | 01   | A6     |

>  上行：AA 00 09 02 0A E5 00 00 00 01 01 A6
>
>  下行：
>
>  - 联网：AA 00 09 02 0A E5 00 00 00 01 00 A5
>  - 未联网：AA 00 09 02 0A E5 00 00 00 01 01 A6

### 网络状态通知

模组在网络状态变化时主动通知mcu，mcu可在收到通知后改变网络指示灯。

| Head | Length | Ver  | Cmd  | Method | Id          | Data | Chksum |
| ---- | ------ | ---- | ---- | ------ | ----------- | ---- | ------ |
| AA   | 00 09  | 02   | 8A   | E1     | 00 00 00 01 | 00   | 21     |

> 下行：
>
> 联网成功：AA 00 09 02 8A E1 00 00 00 01 00 21
>
> 网络断开：AA 00 09 02 8A E1 00 00 00 01 01 22
>
> Ack： AA 00 09 02 8A FF 00 00 00 01 00 3F

## 数据帧

### APP下发属性

app下发属性，支持一次下发多个属性，原则上一次只下发一个属性，多属性通过**服务**下发。

| Head | Length | Ver  | Cmd  | Method | Id          | Data     | Chksum |
| ---- | ------ | ---- | ---- | ------ | ----------- | -------- | ------ |
| AA   | 00 0B  | 02   | 80   | 01     | 00 00 00 01 | 00 01 00 | 3A     |

Data域分解

| typeid | attrid | value |
| ------ | ------ | ----- |
| 00     | 01     | 00    |

> 设置工作状态为待机
>
> 下行：AA 00 0B 02 80 01 00 00 00 01 00 01 00 3A
>
> Ack： AA 00 09 02 80 FF 00 00 00 01 00 35

### APP下发服务

APP下发服务，适用于没有参数或需要一次下发多个属性参数，可以没有返回参数或者返回多个属性参数。

| Head | Length | Ver  | Cmd  | Method | Id          | Data                 | Chksum |
| ---- | ------ | ---- | ---- | ------ | ----------- | -------------------- | ------ |
| AA   | 00 0F  | 02   | 80   | 02     | 00 00 00 01 | 01 02 02 01 02 03 2D | 76     |

Data域分解

| serviceid | typeid | attrid | value | typeid | attrid | value |
| --------- | ------ | ------ | ----- | ------ | ------ | ----- |
| 01        | 02     | 02     | 01    | 02     | 03     | 2D    |

> 开始工作，精华煮，45分钟
>
> 下行：AA 00 0F 02 80 02 00 00 00 01 01 02 02 01 02 03 2D 76
>
> Ack： AA 00 09 02 80 FF 00 00 00 01 00 35

### mcu上报属性
设备上报属性，支持多属性同时上报，**建议在设备属性值变化和网络连接成功时（包括重连）上报。**

| Head | Length | Ver  | Cmd  | Method | Id          | Data                                | Chksum |
| ---- | ------ | ---- | ---- | ------ | ----------- | ----------------------------------- | ------ |
| AA   | 00 14  | 02   | 00   | 80     | 00 00 00 01 | 00 01 01 02 02 01 02 03 2D 02 03 14 | 93     |

Data域分解

| typeid | attrid | value | typeid | attrid | value | typeid | attrid | value | typeid | attrid | value |
| ------ | ------ | ----- | ------ | ------ | ----- | ------ | ------ | ----- | ------ | ------ | ----- |
| 00     | 01     | 01    | 02     | 02     | 01    | 02     | 03     | 2D    | 02     | 03     | 14    |

> 属性上报，工作状态：工作中，工作模式：精华煮，工作时间：45分钟，工作剩余时间：20分钟
>
> 上行：AA 00 14 02 00 80 00 00 00 01 00 01 01 02 02 01 02 03 2D 02 03 14 93
>
> Ack： AA 00 09 02 00 FF 00 00 00 01 00 B5

### mcu上报事件
设备上报事件，上报参数可为空。

| Head | Length | Ver  | Cmd  | Method | Id          | Data                 | Chksum |
| ---- | ------ | ---- | ---- | ------ | ----------- | -------------------- | ------ |
| AA   | 00 0F  | 02   | 00   | 81     | 00 00 00 01 | 01 02 02 01 02 03 2D | 75     |

Data域分解

| eventid | typeid | attrid | value | typeid | attrid | value |
| ------- | ------ | ------ | ----- | ------ | ------ | ----- |
| 01      | 02     | 02     | 01    | 02     | 03     | 2D    |

> 煮饭完成，精华煮，45分钟
>
> 上行：AA 00 0F 02 00 81 00 00 00 01 01 02 02 01 02 03 2D 75
>
> Ack： AA 00 09 02 00 FF 00 00 00 01 00 B5

