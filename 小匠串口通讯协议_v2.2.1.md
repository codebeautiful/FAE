# 小匠串口通讯协议

获取最新版本小匠串口通讯协议：https://github.com/xiaojiangIoT/FAE

## MCU与模组串口连接要求

通讯方式：UART

波特率：9600

数据位：8

奇偶校验：无

停止位：1

数据流控：无

数据传输统一使用**大端字节序**（高字节在前，低字节在后）

为保证传输可靠性，通信需要实现应答，超时及重传机制

## 协议帧组成部分

| 1Byte | 2Bytes | 1Byte | 1Byte | nBytes  | 1Byte  |
| ----- | ------ | ----- | ----- | ------- | ------ |
| Head  | Length | Ver   | Cmd   | Payload | Chksum |

**字段解析**

| **字段名** | **长度（字节）** | **说明**                   |
| ---------- | ---------------- | -------------------------- |
| Head       | 1                | 固定位0xAA                 |
| Length     | 2                | 表示ver到chksum的长度      |
| Ver        | 1                | 协议版本号，目前为**0x02** |
| Cmd        | 1                | 帧类型                     |
| Payload    | n                | 有效载荷（变长数据）       |
| Chksum     | 1                | 前面所有字节的和校验       |

### Cmd定义

**MCU—>模组（上行）最高位置0**

| 指令     | 数据类型   | Cmd                        | 描述               |
| -------- | ---------- | -------------------------- | ------------------ |
| 数据帧   | 透传数据   | 发送：0x00<br />回应：0x00 | 模组转发，无需解析 |
| 非数据帧 | 非透传数据 | 发送：0x0A<br />回应：0x0A | 模组解析           |

**模组—>MCU（下行）最高位置1**


| 指令     | 数据类型   | Cmd                        | 描述               |
| -------- | ---------- | -------------------------- | ------------------ |
| 数据帧   | 透传数据   | 发送：0x80<br />回应：0x80 | 模组转发，无需解析 |
| 非数据帧 | 非透传数据 | 发送：0x8A<br />回应：0x8A | 模组解析           |

### Payload定义

| 1Byte  | 4Bytes | nByte |
| ------ | ------ | ----- |
| Method | Id     | Data  |

**各字段说明如下：**

#### Method

**定义如下：**

**上行**

| Name   | Method | 帧类型   | 描述                                                         |
| ------ | ------ | -------- | ------------------------------------------------------------ |
| Report | 0x80   | 数据帧   | 设备上报设备**属性**，<br />通过ACK回复                      |
| Event  | 0x81   | 数据帧   | 设备上报设备**事件**，<br />通过ACK回复                      |
| GetMod | 0xC0   | 非数据帧 | 设备获取模组**系统保留属性**，<br />成功通过GetMod回复，失败则通过ACK回复 |
| SetMod | 0xC1   | 非数据帧 | 设备端配置模组**系统保留属性**，<br />通过ACK回复            |

**下行**

| Name      | Method | 帧类型   | 描述                                                         |
| --------- | ------ | -------- | ------------------------------------------------------------ |
| Get       | 0x00   | 数据帧   | 服务端获取设备**属性**，<br />成功通过Get回复，失败通过ACK回复 |
| Set       | 0x01   | 数据帧   | 服务端下发设备**属性**，<br />通过ACK回复                    |
| Service   | 0x02   | 数据帧   | 服务端下发设备**服务**，<br />通过Service回复                |
| ReportDev | 0x40   | 非数据帧 | 模组向设备通知**系统保留属性**改变，<br />通过ACK回复        |
| GetDev    | 0x50   | 非数据帧 | 模组向设备获取**系统保留属性**，<br />成功通过GetDev回复，失败则通过ACK回复 |

**通用**

| Name | Method | 帧类型   | 描述                                                         |
| ---- | ------ | -------- | ------------------------------------------------------------ |
| ACK  | 0xFF   | 非数据帧 | 通用应答，带状态码（error code）可用于请求的出错回复，正确为0x00 |

> 参考：[小匠串口通讯协议method时序图](https://github.com/xiaojiangIoT/FAE/issues/1)

#### Id

帧标识符，用于区分不同的请求。**回复帧与请求帧的id必须相同**，表示对该帧的回复。

#### Data域格式

Data域格式根据具体的method来确定。

**attrid**表示数据属性id，分**产品属性**和**系统保留属性**。

产品属性可联系小匠对接人获取。

**系统保留属性定义如下：**

**上行：**

| attrid | type   | method | 说明                                                         |
| ------ | ------ | ------ | ------------------------------------------------------------ |
| 200    | string | GetMod | 查询模组信息，以字符串表示：“XXXX.YYYY.ZZZZ”，固定长度14字节 |
| 201    | uint8  | GetMod | 查询模组网络状态                                             |
| 202    | uint8  | SetMod | 使能配网                                                     |
| 210    | uint32 | SetMod | 设置pid，**米家产品使用**                                    |
| 211    | string | SetMod | 设置model，**米家产品使用**                                  |
| 212    | string | SetMod | 设置mcu version，**米家产品使用**                            |

**下行：**

| attrid | type  | method    | 说明                    |
| ------ | ----- | --------- | ----------------------- |
| 201    | uint8 | ReportDev | 模组通知mcu网络状态变化 |
| 203    | uint8 | GetDev    | 模组获取设备快照        |
| 204    | uint8 | ReportDev  ｜模组发送给mcu的心跳，15s一次        |


**模组网络状态定义如下：**

| data | 备注         |
| ---- | ------------ |
| 0x00 | 设备连接成功 |
| 0x01 | 设备未连接   |

**各method的data域定义如下：**

##### Get/GetMod/GetDev

| 1Byte  | 1Byte  | nByte |
| ------ | ------ | ----- |
| attrid | attrid | …….   |

##### Set/Report/SetMod/ReportDev/GetMod回复/GetDev回复

| 1Byte  | 1Byte  | [2Bytes] | nBytes |
| ------ | ------ | -------- | ------ |
| typeid | attrid | [len]    | value  |

- typeid 表示数据类型，对应关系见下表。
- len表示value的长度，由于基础类型数据长度是已知的，**仅在类型为结构体、时间、文本（text）的情况下需要**。
- value表示数据属性的值。

| 数据类型（typeid）                             | 值   |
| ---------------------------------------------- | ---- |
| PROTOCOL_PROP_TYPE_BOOL（布尔型）              | 0    |
| PROTOCOL_PROP_TYPE_INT8（有符号8位整型） | 1    |
| PROTOCOL_PROP_TYPE_UINT8（无符号8位整型、枚举）      | 2    |
| PROTOCOL_PROP_TYPE_INT16（有符号16位整型）     | 3    |
| PROTOCOL_PROP_TYPE_UINT16（无符号16位整型）    | 4    |
| PROTOCOL_PROP_TYPE_INT32（有符号32位整型）     | 5    |
| PROTOCOL_PROP_TYPE_UINT32（无符号32位整型）    | 6    |
| PROTOCOL_PROP_TYPE_INT64（有符号64位整型）     | 7    |
| PROTOCOL_PROP_TYPE_UINT64（无符号64位整型）    | 8    |
| PROTOCOL_PROP_TYPE_FLOAT32（32位浮点型）       | 9    |
| PROTOCOL_PROP_TYPE_FLOAT64（64位浮点型）       | 10   |
| PROTOCOL_PROP_TYPE_STRING（字符串）            | 11   |
| PROTOCOL_PROP_TYPE_DATE（日期）                | 12   |
| PROTOCOL_PROP_TYPE_STRUCT（结构体）            | 13   |

##### Service/Event

| 1Byte | nByte      |
| ----- | ---------- |
| ID    | parameters |

对服务和事件进行编号传输，ID表示服务或者事件的编号，parameters表示服务或者事件携带的参数(与Set一致)。

##### Ack格式

| 1Byte   |
| ------- |
| errcode |

| Errcode | 说明                 |
| ------- | -------------------- |
| 0       | OK                   |
| 1       | ERROR                |
| 2       | 操作不允许           |
| 3       | I/O错误              |
| 4       | 没有对应的设备或地址 |
| 5       | 内存不足             |
| 6       | 设备忙               |
| 7       | 无效参数             |
| 8       | 这项功能没有实现     |
| 9       | 超时                 |
| 10      | 网络异常             |

